import subprocess
import time
config={}
#loadconfig
config['WIRELESS_ADAPTER']=''


# 
attack_params={}
attack_params['WIRELESS_ADAPTER']=''
attack_params['HOST_MAC_ADDRESS']=''
# Get List of Network Adapters
print('Fetching Wireless Network Adapters on Device..')
all_wireless_adapters=[]
wireless_data=''
'''
with subprocess.Popen(['cat','/proc/net/wireless'], stdout = subprocess.PIPE) as data:
    wireless_data =data.communicate()
for line in str(wireless_data[0]).split('\\n'):
    if ('|' not in line) and len(line)>1:
        wireless_adapter_details=line.strip()
        details=wireless_adapter_details.split(':')
        name=details[0]
        
        all_wireless_adapters.append(name)
'''

with subprocess.Popen(['iwconfig'], stdout = subprocess.PIPE, stderr=subprocess.STDOUT) as data:
    wireless_data,err =data.communicate()
wireless_data=wireless_data.decode('utf-8').split('\n')
for line in wireless_data:
    if not line.startswith(' ') and 'IEEE' in line:
        all_wireless_adapters.append(line.split(' ')[0])
    

all_wireless_adapters_num=len(all_wireless_adapters)
print('Number of Wireless Adapters Found:',all_wireless_adapters_num)
print('Wireless Adapter names',all_wireless_adapters)
if all_wireless_adapters_num<=0:
    print("No Wireless Network Adapters found. Please recheck the adapters and run..")
    print('exiting the process')
    exit()
print('\n\n')

# Select Network Adapter
if config['WIRELESS_ADAPTER']!='':
    if config['WIRELESS_ADAPTER'] in all_wireless_adapters:
        attack_params['WIRELESS_ADAPTER']=config['WIRELESS_ADAPTER']
        
    else:
        print('Wireless Adapter mentioned in Config file is not present in detected adapters.')
else:
        print("Wireless Network Adapters Identified:")
        for i in range(all_wireless_adapters_num):
            print(i+1,all_wireless_adapters[i])
        while True:
            choice='XY'
            try:
                choices=[x+1 for x in range(all_wireless_adapters_num)]
                print('Choose Wireless Adapter in ',choices,':')
                choice=int(input())
                if choice in choices:
                    attack_params['WIRELESS_ADAPTER']=all_wireless_adapters[i-1]
                    break
                else:
                    print('Sorry. The Wireless Adapter with id',choice,'is not found.')
            except ValueError as ve:
                print('Expect an Integer. Select from the Identified Wireless Network Adapters')
                ve
print('Wireless Adapter Selected:',attack_params['WIRELESS_ADAPTER'])
        
# Bring Adapter down
adapter_data=None
with subprocess.Popen(['ifconfig',attack_params['WIRELESS_ADAPTER'],'down'], stdout = subprocess.PIPE, stderr = subprocess.STDOUT) as data:
    adapter_data =data.communicate()
    
if adapter_data[0] is not None:
    if len(adapter_data[0])>0:
        print('Unhandled Condition occured for ifconfig - stdout:',adapter_data[0])
        print('exiting the process')
        exit()
if adapter_data[1] is not None:
    if len(adapter_data[1])>0:
        print('Unhandled Condition occured for ifconfig - stderr:',adapter_data[1])
        print('exiting the process')
        exit()
print('Successfully brought the wireless adapter down:', attack_params['WIRELESS_ADAPTER'])
print('\n\n\n')



# Change Mac Address
print('Changing Mac Address using macchanger')
mac_data=None
with subprocess.Popen(['macchanger','-r',attack_params['WIRELESS_ADAPTER']], stdout = subprocess.PIPE, stderr = subprocess.STDOUT) as data:
    mac_data =data.communicate()

mac_data_ = mac_data[0]
mac_data__ = mac_data[1]
if mac_data__ is not None:
    print('Unhandled Condition occured for ifconfig - stdout:',mac_data__)
    exit()
mac_data_=mac_data_.decode('utf-8').split('\\n')
for line in mac_data_:
    print(line)

print('\n\n\n')


# Bring Adapter up
adapter_data=None
with subprocess.Popen(['ifconfig',attack_params['WIRELESS_ADAPTER'],'up'], stdout = subprocess.PIPE, stderr = subprocess.STDOUT) as data:
    adapter_data =data.communicate()
    
if adapter_data[0] is not None:
    if len(adapter_data[0])>0:
        print('Unhandled Condition occured for ifconfig - stdout:',adapter_data[0])
        print('exiting the process')
        exit()
if adapter_data[1] is not None:
    if len(adapter_data[1])>0:
        print('Unhandled Condition occured for ifconfig - stderr:',adapter_data[1])
        print('exiting the process')
        exit()
print('Successfully brought the wireless adapter up:', attack_params['WIRELESS_ADAPTER'])
print('\n\n\n')

# Enable Monitor mode on Network Adapter

# 

# Disable Monitor mode on Network Adapter

# Revert back Mac Address
#data = subprocess.Popen(['ifconfig'], stdout = subprocess.PIPE)
#data = subprocess.Popen(['airodump-ng','wlan0'], stdout = subprocess.PIPE)
#output = data.communicate()

